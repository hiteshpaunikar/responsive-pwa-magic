<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor List - ISRO SAC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-4">Doctor List</h1>
      
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Search doctors...">
            <button id="voiceSearchBtn" class="btn btn-outline-secondary">
              <i class="bi bi-mic"></i>
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <select id="filterSelect" class="form-select mb-2">
            <option value="all">Search All Fields</option>
            <option value="AMODOCTORNAME">Doctor Name</option>
            <option value="DOCTORTYPE">Doctor Type</option>
            <option value="MEDICINETYPE">Medicine Type</option>
          </select>
          <div id="searchHint" class="text-muted small"></div>
        </div>
      </div>

      <div id="doctorsList" class="row row-cols-1 row-cols-md-2 g-4">
        <!-- Doctors will be rendered here -->
      </div>
    </div>

    <!-- Add Lovable script before other scripts -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
      let doctors = [];
      let recognition = null;
      let isListening = false;
      let hintTimeout = null;

      // Fetch doctors data
      async function fetchDoctors() {
        try {
          const response = await fetch('/src/data/doctor.json');
          const data = await response.json();
          doctors = data.Doctor;
          renderDoctors(doctors);
        } catch (error) {
          console.error('Error loading doctors:', error);
        }
      }

      // Initialize speech recognition
      if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('searchInput').value = transcript;
          filterDoctors();
          stopRecognition();
        };

        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          stopRecognition();
        };

        recognition.onend = function() {
          stopRecognition();
        };
      }

      function stopRecognition() {
        isListening = false;
        voiceSearchBtn.classList.remove('listening');
      }

      // Voice search button handler
      const voiceSearchBtn = document.getElementById('voiceSearchBtn');
      voiceSearchBtn.addEventListener('click', () => {
        if (recognition) {
          if (!isListening) {
            try {
              recognition.start();
              isListening = true;
              voiceSearchBtn.classList.add('listening');
            } catch (error) {
              console.error('Speech recognition error:', error);
              stopRecognition();
            }
          } else {
            recognition.stop();
            stopRecognition();
          }
        } else {
          alert('Speech recognition is not supported in your browser.');
        }
      });

      function renderDoctors(doctorsToRender) {
        const doctorsList = document.getElementById('doctorsList');
        if (doctorsToRender.length === 0) {
          doctorsList.innerHTML = `
            <div class="alert alert-info" role="alert">
              No doctors found matching your search criteria.
            </div>
          `;
          return;
        }

        doctorsList.innerHTML = doctorsToRender.map(doctor => `
          <div class="card">
            <div class="card-body">
              <h3 class="h5 mb-2">${doctor.AMODOCTORNAME || 'N/A'}</h3>
              <p class="mb-1"><strong>Type:</strong> ${doctor.DOCTORTYPE || 'N/A'}</p>
              <p class="mb-1"><strong>Medicine:</strong> ${doctor.MEDICINETYPE || 'N/A'}</p>
              <p class="mb-1"><strong>Timings:</strong> ${doctor.AMOTIMINGS || 'N/A'}</p>
              <p class="mb-1"><strong>Phone:</strong> ${doctor.AMOPHONENO || 'N/A'}</p>
              <p class="mb-0"><strong>Address:</strong> ${[doctor.AMOHOUSENO, doctor.AMOSTREET, doctor.AMOPLACE].filter(Boolean).join(', ') || 'N/A'}</p>
            </div>
          </div>
        `).join('');
      }

      function updateSearchHint(filterType) {
        const hintElement = document.getElementById('searchHint');
        const hints = {
          'all': 'Search across all doctor information fields',
          'AMODOCTORNAME': 'Enter doctor\'s name to search',
          'DOCTORTYPE': 'Search by doctor type (e.g., AMO, BOTH)',
          'MEDICINETYPE': 'Search by medicine type (e.g., ALLOPATHY)'
        };
        
        // Clear any existing timeout
        if (hintTimeout) {
          clearTimeout(hintTimeout);
        }
        
        // Show the hint
        hintElement.textContent = hints[filterType] || '';
        
        // Set new timeout to clear the hint after 3 seconds
        hintTimeout = setTimeout(() => {
          hintElement.textContent = '';
        }, 3000);
      }

      function filterDoctors() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filterType = document.getElementById('filterSelect').value;
        
        const filtered = doctors.filter(doctor => {
          if (filterType === 'all') {
            return Object.values(doctor).some(value => 
              value && value.toLowerCase().includes(searchTerm)
            );
          }
          return doctor[filterType] && 
                 doctor[filterType].toLowerCase().includes(searchTerm);
        });
        
        renderDoctors(filtered);
      }

      // Event listeners
      document.getElementById('searchInput').addEventListener('input', filterDoctors);
      document.getElementById('filterSelect').addEventListener('change', (e) => {
        updateSearchHint(e.target.value);
        filterDoctors();
      });

      // Initial fetch and render
      fetchDoctors();
      updateSearchHint('all'); // Set initial hint
    </script>
  </body>
</html>
